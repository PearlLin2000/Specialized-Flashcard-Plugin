<script lang="ts">

    import { showMessage, confirm } from "siyuan";
    import SettingPanel from "./libs/components/setting-panel.svelte";

    // å£°æ˜æ’ä»¶å®ä¾‹
    export let plugin: any;

    let groups: string[] = ["ğŸ” SQL æŸ¥è¯¢ç»„", "ğŸŒˆ åŸºç¡€è®¾ç½®", "âœ¨ å…¶ä»–è®¾ç½®"];
    let focusGroup = groups[0];

    // SQL ç»„é…ç½®æ•°æ®ç»“æ„
    let sqlGroups = [
        {
            id: 1,
            enabled: true,
            name: "é€¸ç æ ‡ç­¾æŸ¥è¯¢",
            sql: "SELECT * FROM blocks WHERE tag LIKE '%#é€¸ç #%'"
        },
        {
            id: 2,
            enabled: false,
            name: "æ–‡æ¡£å—æŸ¥è¯¢",
            sql: "SELECT * FROM blocks WHERE type = 'd' LIMIT 20"
        },
        {
            id: 3,
            enabled: true,
            name: "æœ€è¿‘ä¿®æ”¹çš„å—",
            sql: "SELECT * FROM blocks ORDER BY updated DESC LIMIT 15"
        }
    ];

    // åŸºç¡€è®¾ç½®ç»„
    const basicSettings: ISettingItem[] = [
        {
            type: 'checkbox',
            title: 'checkbox',
            description: 'checkbox',
            key: 'a',
            value: true
        },
        {
            type: 'textinput',
            title: 'text',
            description: 'This is a text',
            key: 'b',
            value: 'This is a text',
            placeholder: 'placeholder'
        },
        {
            type: 'textarea',
            title: 'textarea',
            description: 'This is a textarea',
            key: 'b2',
            value: 'This is a textarea',
            placeholder: 'placeholder',
            direction: 'row'
        },
        {
            type: 'select',
            title: 'select',
            description: 'select',
            key: 'c',
            value: 'x',
            options: {
                x: 'x',
                y: 'y',
                z: 'z'
            }
        }
    ];

    // å…¶ä»–è®¾ç½®ç»„
    const otherSettings: ISettingItem[] = [
        {
            type: 'button',
            title: 'button',
            description: 'This is a button',
            key: 'e',
            value: 'Click Button',
            button: {
                label: 'Click Me',
                callback: () => {
                    showMessage('Hello, world!');
                }
            }
        },
        {
            type: 'slider',
            title: 'slider',
            description: 'slider',
            key: 'd',
            value: 50,
            slider: {
                min: 0,
                max: 100,
                step: 1
            }
        }
    ];

    // æ·»åŠ æ–°çš„ SQL ç»„
    function addSQLGroup() {
        const newId = Math.max(0, ...sqlGroups.map(g => g.id)) + 1;
        sqlGroups = [...sqlGroups, {
            id: newId,
            enabled: false,
            name: `æ–°æŸ¥è¯¢ç»„ ${newId}`,
            sql: "SELECT * FROM blocks LIMIT 10"
        }];
    }

    // åˆ é™¤ SQL ç»„
    function removeSQLGroup(groupId: number) {
        const group = sqlGroups.find(g => g.id === groupId);
        confirm(
            "ç¡®è®¤åˆ é™¤",
            `ç¡®å®šè¦åˆ é™¤æŸ¥è¯¢ç»„ "${group?.name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
            () => {
                sqlGroups = sqlGroups.filter(g => g.id !== groupId);
                showMessage(`å·²åˆ é™¤æŸ¥è¯¢ç»„: ${group?.name}`);
            }
        );
    }

    // å…¨å±€ä¿å­˜é…ç½®
    async function saveAllSettings() {
        try {
            // ä½¿ç”¨æ’ä»¶çš„ saveData æ–¹æ³•ä¿å­˜ SQL ç»„é…ç½®
            await this.plugin.saveData('sqlGroups', sqlGroups);
            showMessage('æ‰€æœ‰é…ç½®å·²ä¿å­˜');
        } catch (error) {
            console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
            showMessage('ä¿å­˜é…ç½®å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
        }
    }

    /********** åŸºç¡€è®¾ç½®å’Œå…¶ä»–è®¾ç½®çš„äº‹ä»¶å¤„ç† **********/
    interface ChangeEvent {
        group: string;
        key: string;
        value: any;
    }

    const onChanged = ({ detail }: CustomEvent<ChangeEvent>) => {
        console.log("è®¾ç½®å˜æ›´:", detail);
        
        if (detail.group === groups[1]) {
            // åŸºç¡€è®¾ç½®çš„å˜æ›´å¤„ç† - ä½¿ç”¨åŸæœ‰çš„è‡ªåŠ¨ä¿å­˜æœºåˆ¶
            console.log("åŸºç¡€è®¾ç½®å˜æ›´:", detail.key, detail.value);
        } else if (detail.group === groups[2]) {
            // å…¶ä»–è®¾ç½®çš„å˜æ›´å¤„ç† - ä½¿ç”¨åŸæœ‰çš„è‡ªåŠ¨ä¿å­˜æœºåˆ¶
            console.log("å…¶ä»–è®¾ç½®å˜æ›´:", detail.key, detail.value);
        }
        // ä¸æ˜¾ç¤ºæ¶ˆæ¯ï¼Œä½¿ç”¨åŸæœ‰çš„ä¿å­˜æœºåˆ¶
        //plugin.save();
    };
</script>

<div class="fn__flex-1 fn__flex config__panel">
    <ul class="b3-tab-bar b3-list b3-list--background">
        {#each groups as group}
            <li
                class:b3-list-item--focus={group === focusGroup}
                class="b3-list-item"
                on:click={() => { focusGroup = group; }}
            >
                <span class="b3-list-item__text">{group}</span>
            </li>
        {/each}
    </ul>
    
    <div class="config__tab-wrap">
        <!-- SQL æŸ¥è¯¢ç»„é¢æ¿ -->
        {#if focusGroup === groups[0]}
        <div class="sql-groups-panel">
            <div class="b3-label config__panel-title">
                SQL æŸ¥è¯¢ç»„é…ç½®
                <div class="config__panel-desc">
                    é…ç½®å¤šä¸ª SQL æŸ¥è¯¢ç»„ï¼Œå¯ç”¨åå°†åœ¨é—ªå¡åŠŸèƒ½ä¸­ä½¿ç”¨å¯¹åº”çš„æŸ¥è¯¢è¯­å¥
                </div>
            </div>

            <!-- SQL ç»„åˆ—è¡¨ï¼ˆå¸¦æ»šåŠ¨æ¡ï¼‰ -->
            <div class="sql-groups-list-container">
                <div class="sql-groups-list">
                    {#each sqlGroups as group (group.id)}
                    <div class="sql-group-item">
                        <div class="sql-group-header">
                            <!-- å¯ç”¨å¼€å…³ -->
                            <label class="b3-label config__item compact-item">
                                <input 
                                    type="checkbox" 
                                    bind:checked={group.enabled}
                                    class="b3-switch fn__flex-center"
                                />
                                <span class="config__item-name">å¯ç”¨</span>
                            </label>

                            <!-- ç»„åè¾“å…¥ -->
                            <div class="config__item compact-item">
                                <input 
                                    type="text" 
                                    bind:value={group.name}
                                    class="b3-text-field fn__flex-1 compact-input" 
                                    placeholder="ç»„åˆ«åç§°"
                                />
                            </div>

                            <!-- åˆ é™¤æŒ‰é’® -->
                            <button 
                                class="b3-button b3-button--error compact-button"
                                on:click={() => removeSQLGroup(group.id)}
                                title="åˆ é™¤æ­¤æŸ¥è¯¢ç»„"
                            >
                                âˆ’
                            </button>
                        </div>

                        <!-- SQL è¾“å…¥æ¡† -->
                        <div class="config__item compact-item">
                            <textarea 
                                bind:value={group.sql}
                                class="b3-text-field fn__flex-1 sql-textarea" 
                                placeholder="è¾“å…¥ SQL æŸ¥è¯¢è¯­å¥..."
                                rows="3"
                            />
                        </div>
                    </div>
                    {/each}
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
            <div class="sql-groups-actions">
                <button 
                    class="b3-button b3-button--outline"
                    on:click={addSQLGroup}
                >
                    + æ·»åŠ æŸ¥è¯¢ç»„
                </button>
                <div class="fn__space"></div>
                <button 
                    class="b3-button b3-button--text"
                    on:click={saveAllSettings}
                >
                    ä¿å­˜é…ç½®
                </button>
            </div>
        </div>
        {/if}

        <!-- åŸºç¡€è®¾ç½®é¢æ¿ -->
        <SettingPanel
            group={groups[1]}
            settingItems={basicSettings}
            display={focusGroup === groups[1]}
            on:changed={onChanged}
        >
            <div class="fn__flex b3-label">
                ğŸ’¡ è¿™æ˜¯åŸºç¡€è®¾ç½®é¢æ¿çš„è¯´æ˜åŒºåŸŸã€‚
            </div>
        </SettingPanel>

        <!-- å…¶ä»–è®¾ç½®é¢æ¿ -->
        <SettingPanel
            group={groups[2]}
            settingItems={otherSettings}
            display={focusGroup === groups[2]}
            on:changed={onChanged}
        >
            <div class="fn__flex b3-label">
                ğŸ’¡ è¿™æ˜¯å…¶ä»–è®¾ç½®é¢æ¿çš„è¯´æ˜åŒºåŸŸã€‚
            </div>
        </SettingPanel>
    </div>
</div>

<style lang="scss">
    .config__panel {
        height: 100%;
    }
    .config__panel > ul > li {
        padding-left: 1rem;
    }

    .config__panel-title {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 15px;
        padding: 0 5px;
    }

    .config__panel-desc {
        font-size: 12px;
        color: var(--b3-theme-on-surface-light);
        margin-top: 5px;
        font-weight: normal;
    }

    .sql-groups-panel {
        padding: 15px;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .sql-groups-list-container {
        flex: 1;
        overflow-y: auto;
        max-height: calc(100vh - 200px);
        margin-bottom: 15px;
        border: 1px solid var(--b3-theme-surface-lighter);
        border-radius: 4px;
        padding: 10px;
    }

    .sql-groups-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .sql-group-item {
        border: 1px solid var(--b3-theme-surface-lighter);
        border-radius: 4px;
        padding: 10px;
        background: var(--b3-theme-surface);
    }

    .sql-group-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }

    .compact-item {
        margin-bottom: 0 !important;
        flex: 1;
    }

    .compact-item .config__item-name {
        font-size: 12px;
        margin-bottom: 2px;
    }

    .compact-input {
        height: 28px;
        font-size: 12px;
        padding: 4px 8px;
    }

    .compact-button {
        width: 28px !important;
        height: 28px !important;
        padding: 0 !important;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
    }

    .sql-textarea {
        font-family: monospace;
        resize: vertical;
        min-height: 60px;
        padding: 6px 8px;
    }

    .sql-groups-actions {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        flex-shrink: 0;
    }

    .config__item {
        display: flex;
        flex-direction: column;
        margin-bottom: 12px;
    }

    .config__item .config__item-name {
        font-weight: 600;
        margin-bottom: 2px;
        color: var(--b3-theme-on-background);
        font-size: 12px;
    }

    /* ç´§å‡‘å¸ƒå±€çš„å¼€å…³æ ·å¼ */
    .b3-switch {
        transform: scale(0.9);
    }

    /* æ»šåŠ¨æ¡æ ·å¼ */
    .sql-groups-list-container::-webkit-scrollbar {
        width: 6px;
    }

    .sql-groups-list-container::-webkit-scrollbar-track {
        background: var(--b3-theme-surface);
        border-radius: 3px;
    }

    .sql-groups-list-container::-webkit-scrollbar-thumb {
        background: var(--b3-theme-on-surface-light);
        border-radius: 3px;
    }

    .sql-groups-list-container::-webkit-scrollbar-thumb:hover {
        background: var(--b3-theme-on-surface);
    }

    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 768px) {
        .sql-group-header {
            flex-wrap: wrap;
        }
        
        .compact-item {
            min-width: auto;
        }
        
        .sql-groups-actions {
            flex-direction: column;
            gap: 8px;
        }
    }
</style>