//å®šæ—¶æ‰«æå¹¶é™é»˜æ¨è¿Ÿå½“æ—¥åˆ›å»ºçš„é—ªå¡2å¤©
// ===== å¯é…ç½®å‚æ•° =====
const POSTPONE_DAYS = "2"; // å¯è½»æ¾ä¿®æ”¹æ¨è¿Ÿå¤©æ•°
const SCAN_INTERVAL = 15; // æ‰«æé—´éš”ï¼ˆåˆ†é’Ÿï¼‰

// ===== æ—¥æœŸå¤„ç†å·¥å…·å‡½æ•° =====
const getTodayString = () => {
  const today = new Date();
  return [
    today.getFullYear(),
    String(today.getMonth() + 1).padStart(2, '0'),
    String(today.getDate()).padStart(2, '0')
  ].join('');
};

// ===== å¡ç‰‡çŠ¶æ€æ£€æµ‹ç­–ç•¥ =====
const cardStatusStrategies = {
  isTodayCard: (card, todayString) => 
    card.riffCardID?.startsWith(todayString),
  
  isNotSuspended: (card) => 
    !(card.ial?.bookmark === "ğŸ›‘ Suspended Cards" || 
      card.ial?.["custom-card-priority-stop"] !== undefined)
};

// ===== ç­›é€‰å‡½æ•° =====
function filterTodayCards(cards) {
  const todayString = getTodayString();
  return cards.filter(card => 
    cardStatusStrategies.isTodayCard(card, todayString) && 
    cardStatusStrategies.isNotSuspended(card)
  );
}

// ===== æ‰§è¡Œæ¨è¿Ÿæ“ä½œçš„å‡½æ•° =====
const postponeTodayCardsDirectly = async () => {
  try {
    console.log(`å¼€å§‹æ‰§è¡Œæ¨è¿Ÿæ“ä½œï¼Œæ¨è¿Ÿå¤©æ•°: ${POSTPONE_DAYS}`);
    
    // è·å–æ‰€æœ‰å¡ç‰‡
    const allCards = await tomato_zZmqus5PtYRi.siyuan.getRiffCardsAllFlat();
    // ç­›é€‰ä»Šæ—¥å¡ç‰‡
    const todayCards = filterTodayCards(allCards);
    
    console.log(`æ‰¾åˆ° ${todayCards.length} å¼ ä»Šæ—¥å¡ç‰‡`);
    
    if (todayCards.length > 0) {
      // è°ƒç”¨æ¨è¿Ÿå‡½æ•°ï¼Œä½¿ç”¨é…ç½®çš„å‚æ•°
      await tomato_zZmqus5PtYRi.cardPriorityBox.stopCards(todayCards, false, POSTPONE_DAYS);
      console.log(`æˆåŠŸæ¨è¿Ÿ ${todayCards.length} å¼ ä»Šæ—¥å¡ç‰‡ ${POSTPONE_DAYS} å¤©`);
    } else {
      console.log("æ²¡æœ‰æ‰¾åˆ°ä»Šæ—¥åˆ›å»ºçš„å¡ç‰‡");
    }
  } catch (error) {
    console.error("æ¨è¿Ÿæ“ä½œå¤±è´¥:", error);
  }
};

// ===== å®šæ—¶æ‰«æåŠŸèƒ½ =====
let scanIntervalId = null;

// å¯åŠ¨å®šæ—¶æ‰«æ
const startScheduledScanning = () => {
  // æ¸…é™¤ç°æœ‰çš„å®šæ—¶å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
  if (scanIntervalId) {
    clearInterval(scanIntervalId);
  }
  
  // ç«‹å³æ‰§è¡Œä¸€æ¬¡
  postponeTodayCardsDirectly();
  
  // è®¾ç½®å®šæ—¶å™¨ï¼Œæ¯éš”æŒ‡å®šåˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  const intervalMs = SCAN_INTERVAL * 60 * 1000; // è½¬æ¢ä¸ºæ¯«ç§’
  scanIntervalId = setInterval(postponeTodayCardsDirectly, intervalMs);
  
  console.log(`å·²å¯åŠ¨å®šæ—¶æ‰«æï¼Œæ¯éš” ${SCAN_INTERVAL} åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡`);
};

// åœæ­¢å®šæ—¶æ‰«æ
const stopScheduledScanning = () => {
  if (scanIntervalId) {
    clearInterval(scanIntervalId);
    scanIntervalId = null;
    console.log("å·²åœæ­¢å®šæ—¶æ‰«æ");
  }
};

// ç«‹å³å¯åŠ¨å®šæ—¶æ‰«æ
startScheduledScanning();

// å¯¼å‡ºå‡½æ•°ï¼Œä»¥ä¾¿åœ¨éœ€è¦æ—¶å¯ä»¥æ‰‹åŠ¨åœæ­¢æ‰«æ
// ä¾‹å¦‚ï¼šwindow.stopAutoPostpone = stopScheduledScanning;